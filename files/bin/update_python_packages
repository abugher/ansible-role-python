#!/bin/bash

target_user='python-packages'

printf "Current user:  '%s'\n" "${USER}"

if ! test "${target_user}" = "${USER}"; then
  printf "Switching user to:  '%s'\n" "${target_user}"
  exec su - "${target_user}" "${0}" "${@}"
fi

shopt -s nullglob
ret=0
for venv in /usr/local/python-packages/*; do
  package="${venv##*/}"
  "${venv}"/bin/pip3 \
    install \
    -U \
    --require-virtualenv \
    --upgrade-strategy eager \
    "${package}"
  if ! test 0 = "${?}"; then
    ret=1
  fi
done

exit "${ret}"
